<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Registrasi - Yayasan Sahabat Qur'an</title>
  <link rel="stylesheet" href="../css/admin.css" />
</head>
<body>
  <div style="max-width:1080px;margin:24px auto;background:var(--cream);padding:18px;border-radius:18px;box-shadow:var(--shadow)">
    
    <div style="display:flex;justify-content:space-between;align-items:center">
      <h2>Registrasi Pendaftar</h2>
      <div>
        <button class="btn btn-neutral" onclick="goBack()">‚Üê Kembali</button>
        <button class="btn btn-add" onclick="exportPendaftar()">Ekspor Laporan</button>
      </div>
    </div>

    <div style="margin-top:16px;display:flex;gap:18px">
      
      <!-- LIST PENDAFTAR -->
      <div style="flex:1">
        <div class="table-card">
          <h3>Daftar Pendaftar</h3>
          <table id="list">
            <thead>
              <tr>
                <th>No</th>
                <th>Nama</th>
                <th>Tempat Lahir</th>
                <th>Status</th>
                <th>Aksi</th>
              </tr>
            </thead>
            <tbody></tbody>
          </table>
        </div>
      </div>

      <!-- DETAIL PENDAFTAR -->
      <div style="width:380px">
        <div class="table-card">
          <h3>Detail Pendaftar</h3>
          <div id="detailArea">
            <p>Pilih pendaftar untuk melihat detail.</p>
          </div>
        </div>
      </div>

    </div>
  </div>

<script>
/* ========================
   HELPER FUNCTION
======================== */

function goBack() {
  window.location.href = 'dashboardadmin.html';
}

function renderBadge(status) {
  if (!status) return '<span class="badge wait">Menunggu</span>';
  if (status === 'diterima') return '<span class="badge accept">Diterima</span>';
  if (status === 'ditolak') return '<span class="badge reject">Ditolak</span>';
  return '<span class="badge wait">Menunggu</span>';
}

/* ========================
   LOAD DATA DARI BACKEND
======================== */

async function loadPendaftar() {
  const res = await fetch("http://localhost:5000/pendaftar", {
    headers: { 
      "Authorization": "Bearer " + localStorage.getItem("token")
    }
  });

  return await res.json();
}

/* ========================
   RENDER TABLE LIST PENDAFTAR
======================== */
async function renderList() {
  const tbody = document.querySelector('#list tbody');
  tbody.innerHTML = '';

  const list = await loadPendaftar();

  list.forEach((p, i) => {
    const tr = document.createElement('tr');
    tr.innerHTML = `
      <td>${i + 1}</td>
      <td>${p.nama}</td>
      <td>${p.tempat_lahir || '-'}</td>
      <td>${renderBadge(p.status)}</td>
      <td>
        <button class="btn btn-neutral" onclick="selectPendaftar(${p.id_pendaftar})">Lihat</button>
      </td>
    `;
    tbody.appendChild(tr);
  });
}

/* ========================
   RENDER DETAIL PENDAFTAR
======================== */

async function selectPendaftar(id) {
  const list = await loadPendaftar();
  const p = list.find(x => x.id_pendaftar == id);

  if (!p) return;

  currentId = id;

  const area = document.getElementById("detailArea");
  area.innerHTML = `
    <label>Nama</label>
    <input class="input" value="${p.nama}" disabled>

    <label>Tempat Lahir</label>
    <input class="input" value="${p.tempat_lahir || ''}" disabled>

    <label>Tanggal Lahir</label>
    <input class="input" value="${p.tanggal_lahir || ''}" disabled>

    <label>Email</label>
    <input class="input" value="${p.email}" disabled>

    <label>No WA</label>
    <input class="input" value="${p.no_wa}" disabled>

    <label>Status Saat Ini</label>
    ${renderBadge(p.status)}

    <div style="margin-top:12px;text-align:right">
      <button class="btn" onclick="resetDetail()">Tutup</button>
      <button class="btn btn-add" onclick="terima(${p.id_pendaftar})">Terima</button>
      <button class="btn btn-neutral" onclick="tolak(${p.id_pendaftar})">Tolak</button>
    </div>
  `;
}

function resetDetail() {
  document.getElementById("detailArea").innerHTML = '<p>Pilih pendaftar untuk melihat detail.</p>';
}

/* ========================
   ACTION: TERIMA / TOLAK
======================== */

async function terima(id) {
  const res = await fetch(`http://localhost:5000/pendaftar/terima/${id}`, {
    method: "PUT",
    headers: {
      "Authorization": "Bearer " + localStorage.getItem("token")
    }
  });

  const data = await res.json();
  alert(data.message);
  renderList();
  resetDetail();
}

async function tolak(id) {
  const res = await fetch(`http://localhost:5000/pendaftar/tolak/${id}`, {
    method: "PUT",
    headers: {
      "Authorization": "Bearer " + localStorage.getItem("token")
    }
  });

  const data = await res.json();
  alert(data.message);
  renderList();
  resetDetail();
}

/* ========================
   EXPORT CSV
======================== */

async function exportPendaftar() {
  const list = await loadPendaftar();
  if (!list.length) return alert("Tidak ada data");

  let csv = "Nama,Tempat,Tanggal Lahir,WA,Email,Status\n";

  list.forEach(r => {
    csv += `"${r.nama}","${r.tempat_lahir}","${r.tanggal_lahir}","${r.no_wa}","${r.email}","${r.status}"\n`;
  });

  const blob = new Blob([csv], { type: "text/csv" });
  const url = URL.createObjectURL(blob);
  const a = document.createElement("a");
  a.href = url;
  a.download = "pendaftar.csv";
  a.click();
  URL.revokeObjectURL(url);
}

/* ========================
   INITIAL LOAD
======================== */

window.addEventListener('DOMContentLoaded', renderList);
</script>

</body>
</html>
