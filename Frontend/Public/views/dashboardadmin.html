<!DOCTYPE html>
<html lang="id">

<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Dashboard Admin - Yayasan Sahabat Qur'an</title>
  <link rel="stylesheet" href="../css/admin.css" />
</head>

<body>
  <div class="app">

    <!-- SIDEBAR -->
    <aside class="sidebar">
      <img src="../images/LogoYSQ.png" alt="logo" class="logo" onerror="this.style.display='none'" />

      <div class="profile">
        <div class="avatar" id="sidebarAvatar">ğŸ‘¤</div>
        <h3 id="sidebarName">Nama Admin</h3>
        <p id="sidebarEmail">email@contoh.com</p>
        <p style="font-style:italic;font-size:13px;color:#d8d4b3" id="sidebarPhone">No. tlp</p>
      </div>

      <div class="side-btn">
        <a href="dashboardadmin.html" class="active">ğŸ  Dashboard</a>
        <a href="../views/jadwaladmin.html">ğŸ“… Daftar Jadwal</a>
        <a href="../views/kelasadmin.html">ğŸ·ï¸ Daftar Kelas</a>
        <a href="../views/daftarsantri.html">ğŸ‘¨â€ğŸ“ Daftar Santri</a>
        <a href="../views/daftarpengajar.html">ğŸ§‘â€ğŸ« Daftar Pengajar</a>
        <a href="../views/riwayatabsensi.html">ğŸ“ Riwayat Absensi</a>
        <a href="../views/rapor.html">ğŸ“š Rapor</a>
        <a href="../views/laporan.html">ğŸ“Š Laporan</a>
      </div>

      <div style="margin-top:auto;width:100%;display:flex;flex-direction:column;gap:10px">
        <button class="btn" style="background:var(--accent);color:#fff;padding:10px;border-radius:12px"
          onclick="openProfile()">Setting Profil</button>

        <button class="btn"
          style="background:transparent;border:1px solid rgba(255,255,255,0.12);color:#fff;padding:10px;border-radius:12px"
          onclick="logout()">Keluar</button>
      </div>
    </aside>

    <!-- MAIN -->
    <main class="main">
      <div class="header">
        <div class="left">
          <h1>Dashboard</h1>
          <small id="greeting">Selamat datang, Admin</small>
        </div>
        <div class="right">
          <div class="date-pill" id="todayDate">--</div>
        </div>
      </div>

      <!-- stats -->
      <div class="card-top">
        <div class="stat">
          <h3>Total Santri Dewasa</h3>
          <p id="totalDewasa">0</p>
        </div>
        <div class="stat">
          <h3>Total Santri Anak-Anak</h3>
          <p id="totalAnak">0</p>
        </div>
        <div class="stat">
          <h3>Total Pengajar</h3>
          <p id="totalPengajar">0</p>
        </div>
        <div class="stat">
          <h3>Total Kelas</h3>
          <p id="totalKelas">0</p>
        </div>
        <div class="stat">
          <h3>Total Pendaftar</h3>
          <p id="totalPendaftar">0</p>
        </div>
      </div>

      <!-- pendaftar table -->
      <div class="table-card">
        <h3>Siswa Pendaftar</h3>

        <div style="margin:8px 0" class="top-actions">
          <input id="searchInput" type="text" placeholder="Cari nama..." class="input"
            style="max-width:300px" oninput="renderPendaftar()" />
          <button class="btn btn-neutral" onclick="exportPendaftar()">Ekspor Semua Pendaftar</button>
        </div>

        <table id="pendaftarTable">
          <thead>
            <tr>
              <th>No</th>
              <th>Nama Lengkap</th>
              <th>Tempat Lahir</th>
              <th>Tanggal Lahir</th>
              <th>Nomor WhatsApp</th>
              <th>Status</th>
              <th>Aksi</th>
            </tr>
          </thead>
          <tbody></tbody>
        </table>
      </div>

    </main>
  </div>

  <!-- MODAL PROFIL -->
  <div class="modal-backdrop" id="profileBackdrop">
    <div class="modal">
      <h3>Profil Admin</h3>

      <label>Email</label>
      <input id="profileEmail" class="input" />

      <label>Nama</label>
      <input id="profileNama" class="input" />

      <label>No. tlp</label>
      <input id="profilePhone" class="input" />

      <label>Alamat</label>
      <input id="profileAlamat" class="input" />

      <div style="text-align:right">
        <button class="btn" onclick="closeProfile()">Tutup</button>
        <button class="btn btn-add" onclick="saveProfile()">Simpan</button>
      </div>
    </div>
  </div>

  <!-- SCRIPT -->
  <script>
    const API = "http://localhost:5000";

    /* ============================================
        CEK LOGIN & ROLE
    ============================================ */
    function checkAuth() {
      const token = localStorage.getItem("token");
      const role = localStorage.getItem("role");

      if (!token || role !== "admin") {
        alert("Akses ditolak. Silakan login sebagai admin.");
        window.location.href = "../login.html";
      }
    }
    checkAuth();


    /* ============================================
        LOAD DATA PENDAFTAR (BACKEND)
    ============================================ */
    let DATA_PENDAFTAR = [];

    async function loadPendaftar() {
      try {
        const res = await fetch(`${API}/pendaftar`, {
          headers: { "Authorization": "Bearer " + localStorage.getItem("token") }
        });

        const data = await res.json();
        DATA_PENDAFTAR = Array.isArray(data) ? data : [];

        renderPendaftar();
        renderStats();
      } catch (err) {
        console.error(err);
        alert("Gagal memuat data pendaftar dari server.");
      }
    }


    /* ============================================
        RENDER PENDAFTAR
    ============================================ */
    function renderPendaftar() {
      const tbody = document.querySelector("#pendaftarTable tbody");
      tbody.innerHTML = "";

      const q = (document.getElementById("searchInput").value || "").toLowerCase();

      const list = DATA_PENDAFTAR.filter(p =>
        p.nama?.toLowerCase().includes(q)
      );

      list.forEach((p, i) => {
        const tr = document.createElement("tr");
        tr.innerHTML = `
          <td>${i + 1}</td>
          <td>${p.nama}</td>
          <td>${p.ttl || "-"}</td>
          <td>${p.tglLahir || "-"}</td>
          <td>${p.whatsapp || "-"}</td>
          <td>${renderStatusBadge(p.status)}</td>
          <td><button class="btn btn-neutral" onclick="openRegistrant('${p.id}')">Buka</button></td>
        `;
        tbody.appendChild(tr);
      });
    }

    function renderStatusBadge(status) {
      if (!status) return '<span class="badge wait">Menunggu</span>';
      if (status.toLowerCase().includes("diterima")) return '<span class="badge accept">Diterima</span>';
      if (status.toLowerCase().includes("ditolak")) return '<span class="badge reject">Ditolak</span>';
      return `<span class="badge wait">${status}</span>`;
    }


    /* ============================================
        STATISTIK
    ============================================ */
    function renderStats() {
      document.getElementById("totalPendaftar").textContent = DATA_PENDAFTAR.length;
      document.getElementById("totalDewasa").textContent =
        DATA_PENDAFTAR.filter(p => p.jenis === "Dewasa" && p.status === "Diterima").length;

      document.getElementById("totalAnak").textContent =
        DATA_PENDAFTAR.filter(p => p.jenis === "Anak" && p.status === "Diterima").length;
    }


    /* ============================================
        PROFIL ADMIN
    ============================================ */
    function openProfile() {
      document.getElementById("profileBackdrop").style.display = "flex";

      document.getElementById("profileEmail").value = localStorage.getItem("admin_email") || "";
      document.getElementById("profileNama").value = localStorage.getItem("admin_nama") || "";
      document.getElementById("profilePhone").value = localStorage.getItem("admin_phone") || "";
      document.getElementById("profileAlamat").value = localStorage.getItem("admin_alamat") || "";
    }

    function closeProfile() {
      document.getElementById("profileBackdrop").style.display = "none";
    }

    function saveProfile() {
      localStorage.setItem("admin_email", document.getElementById("profileEmail").value);
      localStorage.setItem("admin_nama", document.getElementById("profileNama").value);
      localStorage.setItem("admin_phone", document.getElementById("profilePhone").value);
      localStorage.setItem("admin_alamat", document.getElementById("profileAlamat").value);

      closeProfile();
      renderSidebarProfile();
    }

    function renderSidebarProfile() {
      document.getElementById("sidebarEmail").textContent = localStorage.getItem("admin_email") || "-";
      document.getElementById("sidebarName").textContent = localStorage.getItem("admin_nama") || "Admin";
      document.getElementById("sidebarPhone").textContent = localStorage.getItem("admin_phone") || "-";

      const name = localStorage.getItem("admin_nama") || "A";
      document.getElementById("sidebarAvatar").textContent =
        name.split(" ").map(s => s[0]).join("").toUpperCase();
    }


    /* ============================================
        EXPORT CSV
    ============================================ */
    function exportPendaftar() {
      if (!DATA_PENDAFTAR.length) return alert("Tidak ada data");

      let csv = "Nama,Tempat,Tanggal Lahir,WhatsApp,Status,Jenis\n";

      DATA_PENDAFTAR.forEach(p => {
        csv += `"${p.nama}","${p.ttl}","${p.tglLahir}","${p.whatsapp}","${p.status}","${p.jenis}"\n`;
      });

      const blob = new Blob([csv], { type: "text/csv" });
      const url = URL.createObjectURL(blob);

      const a = document.createElement("a");
      a.href = url;
      a.download = "pendaftar_ysq.csv";
      a.click();
    }


    /* ============================================
        NAVIGASI
    ============================================ */
    function openRegistrant(id) {
      window.location.href = `registrasi.html?id=${id}`;
    }

    function logout() {
      localStorage.clear();
      window.location.href = "../login.html";
    }


    /* ============================================
        HALAMAN READY
    ============================================ */
    loadPendaftar();
    renderSidebarProfile();
    document.getElementById("todayDate").textContent =
      new Date().toLocaleDateString("id-ID", { weekday: "long", year: "numeric", month: "long", day: "numeric" });

  </script>

</body>

</html>
